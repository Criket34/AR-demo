<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AR表示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar-nft.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000;
    }
    a-scene { position: fixed; inset: 0; width: 100vw !important; height: 100vh !important; }
    video, canvas { width: 100vw !important; height: 100vh !important; object-fit: contain !important; }
  </style>
</head>
<body>
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; debugUIEnabled: false;">
    
    <a-marker type="pattern" url="doki-color.patt">
      <a-entity
        gltf-model="url(doki-color.glb)"
        scale="0.5 0.5 0.5"
        position="0 0 0"
        rotation="0 180 0">
      </a-entity>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // 画角(FOV)調整（3D描画用）
    function setCameraFOV(sceneEl, fov = 100) {
      const cam = sceneEl?.camera;
      if (cam) { cam.fov = fov; cam.updateProjectionMatrix(); console.log("Camera FOV set to:", cam.fov); }
    }

    // video/canvas 再適用
    function applyContainFit() {
      document.querySelectorAll("video, canvas").forEach(el => {
        el.style.width = "100vw";
        el.style.height = "100vh";
        if (el.tagName.toLowerCase() === "video") el.style.objectFit = "contain";
      });
    }

    // Android 背面カメラ強制
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } }
    }).then(stream => {
      const video = document.querySelector("video");
      if (video) { video.srcObject = stream; video.play(); }
    }).catch(err => console.warn("Camera init error:", err));

    window.addEventListener("resize", applyContainFit);
    window.addEventListener("orientationchange", applyContainFit);

    document.addEventListener("DOMContentLoaded", () => {
      const sceneEl = document.querySelector("a-scene");
      sceneEl.addEventListener("loaded", () => {
        setCameraFOV(sceneEl, 100);
        setTimeout(applyContainFit, 100);
      });
      let tries = 0;
      const t = setInterval(() => { applyContainFit(); if (++tries > 20) clearInterval(t); }, 250);
    });
  </script>
</body>
</html>
