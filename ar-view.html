<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>ARカメラ（doki-colorテスト）</title>

  <style>
    html,body { margin:0; padding:0; height:100%; background:#000; }
    #container { width:100%; height:100vh; overflow:hidden; position:relative; }
    .controls {
      position: absolute;
      z-index: 30;
      left: 12px;
      top: 12px;
      background: rgba(255,255,255,0.9);
      padding: 8px 10px;
      border-radius: 8px;
      font-family: sans-serif;
    }
    .hint-img { max-width:120px; display:block; margin-top:8px; }
  </style>
</head>
<body>
  <div id="container"></div>

  <div class="controls">
    <button id="startBtn">カメラ開始</button>
    <button id="stopBtn" disabled>停止</button>
    <div style="font-size:12px; margin-top:6px;">ターゲット：<strong>doki-color</strong></div>
  </div>

  <!-- three.js UMD版 -->
  <script src="./build/three.min.js"></script>
  <!-- GLTFLoader -->
  <script src="./build/jsm/loaders/GLTFLoader.js"></script>
  <!-- BufferGeometryUtils（GLTFLoader内で参照される可能性あり） -->
  <script src="./build/jsm/utils/BufferGeometryUtils.js"></script>

  <!-- MINDAR -->
  <script src="./MindAR/mindar-image-three.prod.js"></script>
  <script src="./MindAR/compiler.worker.prod.js"></script>
  <script src="./MindAR/controller.worker.prod.js"></script>

  <script>
    async function main() {
      const container = document.getElementById('container');

      const mindarThree = new MINDAR.IMAGE.MindARThree({
        container: container,
        imageTargetSrc: './doki-color.mind',
        uiLoading: "no",
        uiScanning: "no"
      });

      const { renderer, scene, camera } = mindarThree;

      const hemi = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.0);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.5);
      dir.position.set(0, 1, 0);
      scene.add(dir);

      const gltfLoader = new THREE.GLTFLoader();
      const anchor0 = mindarThree.addAnchor(0);

      try {
        const gltf = await new Promise((resolve, reject) => {
          gltfLoader.load('./doki-color.glb', resolve, undefined, reject);
        });
        gltf.scene.scale.set(0.1, 0.1, 0.1);
        gltf.scene.position.set(0, 0, 0);
        anchor0.group.add(gltf.scene);
      } catch (err) {
        console.error('GLB読み込みエラー', err);
      }

      const startBtn = document.getElementById('startBtn');
      const stopBtn  = document.getElementById('stopBtn');

      startBtn.addEventListener('click', async () => {
        try {
          await mindarThree.start();
          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });
          startBtn.disabled = true;
          stopBtn.disabled = false;
        } catch (e) {
          console.error('AR開始エラー', e);
        }
      });

      stopBtn.addEventListener('click', async () => {
        try {
          await mindarThree.stop();
          renderer.setAnimationLoop(null);
          startBtn.disabled = false;
          stopBtn.disabled = true;
        } catch (e) {
          console.error('AR停止エラー', e);
        }
      });

      window.addEventListener('beforeunload', async () => {
        try { await mindarThree.stop(); } catch (e) {}
      });
    }

    main();
  </script>
</body>
</html>
