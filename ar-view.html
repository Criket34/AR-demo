<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AR表示</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar-nft.js"></script>
  <style>
    video {
      object-fit: contain !important; /* Android の過剰ズームを防止 */
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; sourceWidth:1280; sourceHeight:720; debugUIEnabled: false;">

    <!-- ★ マーカーはオブジェクトを持たせず、姿勢検出だけ使う -->
    <a-marker id="marker" type="pattern" url="doki-color.patt"></a-marker>

    <!-- 自前のアンカー（マーカー姿勢を適用する） -->
    <a-entity id="markerAnchor">
      <a-entity 
        gltf-model="url(doki-color.glb)" 
        scale="0.5 0.5 0.5" 
        position="0 0 0" 
        rotation="0 180 0">
      </a-entity>
    </a-entity>

    <!-- 自分のカメラ -->
    <a-camera id="myCamera" position="0 0 5"></a-camera>
  </a-scene>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const markerEl = document.querySelector("#marker");
      const anchorEl = document.querySelector("#markerAnchor");

      // マーカー検出時にオブジェクトを表示
      markerEl.addEventListener("markerFound", () => {
        console.log("Marker found");
        anchorEl.object3D.visible = true;
      });

      // マーカーを見失ったら非表示
      markerEl.addEventListener("markerLost", () => {
        console.log("Marker lost");
        anchorEl.object3D.visible = false;
      });

      // 毎フレーム、マーカーの姿勢をコピー
      markerEl.addEventListener("markerFound", () => {
        const tick = () => {
          if (markerEl.object3D.visible) {
            anchorEl.object3D.position.copy(markerEl.object3D.position);
            anchorEl.object3D.quaternion.copy(markerEl.object3D.quaternion);
            anchorEl.object3D.scale.copy(markerEl.object3D.scale);
          }
          requestAnimationFrame(tick);
        };
        tick();
      });
    });
  </script>
</body>
</html>
